<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spielekarussell Linz - Terminbuchung</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .prose { max-width: 65ch; }
        .notification {
            transition: opacity 0.5s, transform 0.5s;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="relative container mx-auto p-4 md:p-8 max-w-4xl">
        
        <div class="absolute top-4 right-4 md:top-8 md:right-8 z-10">
            <button id="admin-login-link" class="text-sm text-gray-500 hover:text-sky-600 hover:underline">Admin Login</button>
        </div>

        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-sky-600">Spielekarussell Linz</h1>
            <p class="text-lg text-gray-600 mt-2">Ein Projekt des <a href="https://spieleversum.at/" target="_blank" class="text-sky-700 underline">Spieleverein Spieleversum</a></p>
            <p class="text-md text-gray-500 mt-1">Einfach und schnell einen Termin für Ihre Schule oder Ihren Hort buchen.</p>
        </header>

        <main id="main-content">
            <!-- Content wird per JavaScript geladen -->
        </main>

        <div id="loading-view" class="flex justify-center items-center py-20">
             <div class="loader"></div>
        </div>

    </div>

    <!-- Notification Element -->
    <div id="notification" class="notification fixed bottom-4 right-4 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transform translate-y-10 pointer-events-none">
        Notification Text
    </div>

    <!-- Modals -->
    <div id="booking-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md m-4 max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">Termin buchen</h2>
            <p id="modal-termin-info" class="mb-6 text-gray-600"></p>
            <form id="booking-form">
                <input type="hidden" id="termin-id-input">
                <div class="mb-4">
                    <label for="institution-name" class="block text-sm font-medium text-gray-700 mb-1">Name der Einrichtung (Schule/Hort)</label>
                    <input type="text" id="institution-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                </div>
                <div class="mb-4">
                    <label for="contact-person" class="block text-sm font-medium text-gray-700 mb-1">Ansprechperson</label>
                    <input type="text" id="contact-person" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                </div>
                 <div class="mb-4">
                    <label for="contact-address" class="block text-sm font-medium text-gray-700 mb-1">Adresse der Einrichtung</label>
                    <input type="text" id="contact-address" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                </div>
                <div class="mb-4">
                    <label for="contact-phone" class="block text-sm font-medium text-gray-700 mb-1">Telefonnummer</label>
                    <input type="tel" id="contact-phone" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                </div>
                <div class="mb-4">
                    <label for="contact-email" class="block text-sm font-medium text-gray-700 mb-1">E-Mail Adresse</label>
                    <input type="email" id="contact-email" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                </div>
                <div class="mb-6">
                    <label for="contact-notes" class="block text-sm font-medium text-gray-700 mb-1">Anmerkungen / Wunschuhrzeit</label>
                    <textarea id="contact-notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" placeholder="z.B. Beginn bitte erst um 13:00 Uhr"></textarea>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-booking-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Abbrechen</button>
                    <button type="submit" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700">Jetzt verbindlich buchen</button>
                </div>
            </form>
        </div>
    </div>
    <div id="impressum-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-2xl m-4 overflow-y-auto max-h-[80vh]">
            <h2 class="text-2xl font-bold mb-4">Impressum</h2>
            <div class="prose prose-sm max-w-none text-gray-600">
                <p><strong>Angaben gemäß § 5 ECG</strong></p>
                <p>
                    Dipl.-Ing. Ing. Andreas E. Neuhold, BSc.<br>
                    Haushoferstraße 25<br>
                    4020 Linz<br>
                    Österreich
                </p>
                <p>
                    <strong>Kontakt:</strong><br>
                    Telefon: +43 677 624 639 01<br>
                    E-Mail: <a href="mailto:andreas.neuhold@gmail.com">andreas.neuhold@gmail.com</a>
                </p>
                <p><strong>Projektträger:</strong><br><a href="https://spieleversum.at/" target="_blank">Spieleverein Spieleversum</a></p>
                <p><strong>Ausrichtung der Webseite:</strong><br>Private, nicht-kommerzielle Plattform zur Organisation des Projekts "Spielekarussell Linz". Die Nutzung der Seite ist für die teilnehmenden Schulen und Horte kostenlos.</p>
                <p><strong>Online-Streitbeilegung:</strong><br>Die Europäische Kommission stellt eine Plattform zur Online-Streitbeilegung (OS) bereit: <a href="https://ec.europa.eu/consumers/odr" target="_blank">https://ec.europa.eu/consumers/odr</a>. Unsere E-Mail-Adresse finden Sie oben im Impressum.</p>
            </div>
            <div class="flex justify-end mt-6">
                 <button type="button" class="close-modal-btn px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700">Schließen</button>
            </div>
        </div>
    </div>
    <div id="datenschutz-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-2xl m-4 overflow-y-auto max-h-[80vh]">
            <h2 class="text-2xl font-bold mb-4">Datenschutzerklärung</h2>
            <div class="prose prose-sm max-w-none text-gray-600">
                <p>Verantwortlicher für die Datenverarbeitung auf dieser Webseite ist:</p>
                <p>
                    Dipl.-Ing. Ing. Andreas E. Neuhold, BSc.<br>
                    Haushoferstraße 25<br>
                    4020 Linz, Österreich<br>
                    E-Mail: andreas.neuhold@gmail.com
                </p>
                <p><strong>Erhebung und Verarbeitung von Daten:</strong><br>Im Rahmen der Terminbuchung für das Projekt "Spielekarussell Linz" erheben wir folgende Daten: Name der Einrichtung, Name der Ansprechperson, Adresse, Telefonnummer, E-Mail Adresse sowie allfällige Anmerkungen.</p>
                <p><strong>Zweck der Datenverarbeitung:</strong><br>Die von Ihnen bereitgestellten Daten werden ausschließlich zur Organisation, Koordination und Durchführung der gebuchten Spieletage verwendet.</p>
                <p><strong>Datenspeicherung:</strong><br>Ihre Daten werden in einer Firestore-Datenbank (ein Dienst von Google Cloud) gespeichert. Der Serverstandort befindet sich in Frankfurt, Deutschland. Nach Abschluss des Projekts werden alle personenbezogenen Daten gelöscht.</p>
                 <p><strong>Ihre Rechte:</strong><br>Sie haben jederzeit das Recht auf Auskunft, Berichtigung, Löschung oder Einschränkung der Verarbeitung Ihrer gespeicherten Daten. Bitte kontaktieren Sie uns hierfür unter der oben angegebenen E-Mail-Adresse.</p>
            </div>
             <div class="flex justify-end mt-6">
                 <button type="button" class="close-modal-btn px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700">Schließen</button>
            </div>
        </div>
    </div>
    <div id="admin-login-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm m-4">
            <h2 class="text-2xl font-bold mb-4">Admin Login</h2>
            <p class="text-gray-600 mb-6">Bitte melden Sie sich an, um den Admin-Bereich zu betreten.</p>
            <form id="admin-login-form">
                <div class="mb-4">
                    <label for="admin-email" class="block text-sm font-medium text-gray-700 mb-1">E-Mail</label>
                    <input type="email" id="admin-email" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                </div>
                <div class="mb-6">
                    <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">Passwort</label>
                    <input type="password" id="admin-password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                </div>
                <p id="admin-login-error" class="text-red-500 text-sm mb-4 hidden"></p>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-login-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Abbrechen</button>
                    <button type="submit" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700">Anmelden</button>
                </div>
            </form>
        </div>
    </div>
     <div id="edit-termin-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4">Termin bearbeiten</h2>
            <form id="edit-termin-form" class="space-y-4">
                <input type="hidden" id="edit-termin-id">
                <div>
                    <label for="edit-termin-date" class="block text-sm font-medium text-gray-700">Datum</label>
                    <input type="date" id="edit-termin-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="edit-termin-time" class="block text-sm font-medium text-gray-700">Startzeit</label>
                    <input type="time" id="edit-termin-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div>
                    <label for="edit-termin-duration" class="block text-sm font-medium text-gray-700">Dauer (in Minuten)</label>
                    <input type="number" id="edit-termin-duration" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required min="30" step="15" value="90">
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancel-edit-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Abbrechen</button>
                    <button type="submit" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700">Änderungen speichern</button>
                </div>
            </form>
        </div>
    </div>
    <div id="confirm-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm m-4">
            <h2 id="confirm-title" class="text-xl font-bold mb-4">Bestätigung</h2>
            <p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end gap-4">
                <button type="button" id="confirm-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Abbrechen</button>
                <button type="button" id="confirm-ok-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Bestätigen</button>
            </div>
        </div>
    </div>
    
    <footer class="text-center mt-12 text-sm text-gray-500">
        <p>Ein Projekt des <a href="https://spieleversum.at/" target="_blank" class="underline hover:text-sky-600">Spieleverein Spieleversum</a> im Rahmen von 4030 der Stadt Linz.</p>
        <div class="mt-2 space-x-4">
            <a href="#" id="impressum-link" class="underline hover:text-sky-600">Impressum</a>
            <a href="#" id="datenschutz-link" class="underline hover:text-sky-600">Datenschutz</a>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, updateDoc, addDoc, query, where, orderBy, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBdQX7fc8iACTX4DqBt6KNDmt31hUfKtsA",
            authDomain: "private-c25ce.firebaseapp.com",
            projectId: "private-c25ce",
            storageBucket: "private-c25ce.firebasestorage.app",
            messagingSenderId: "669741086329",
            appId: "1:669741086329:web:1a270f74a95d374cc146a8",
            measurementId: "G-5940R8W5F6"
        };

        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase Initialisierung fehlgeschlagen:", e);
            document.getElementById('main-content').innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert"><strong class="font-bold">Fehler!</strong><span class="block">Die Firebase Konfiguration ist ungültig.</span></div>`;
            document.getElementById('loading-view').classList.add('hidden');
            throw new Error("Firebase not configured");
        }

        const mainContent = document.getElementById('main-content');
        const loadingView = document.getElementById('loading-view');
        const terminCollection = collection(db, "termine");

        // --- Helper Functions ---
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.remove('bg-green-500', 'bg-red-500', 'opacity-0', 'translate-y-10');
            notification.classList.add(isError ? 'bg-red-500' : 'bg-green-500');

            setTimeout(() => {
                notification.classList.add('opacity-0', 'translate-y-10');
            }, 3000);
        }

        let confirmCallback = null;
        const confirmModal = document.getElementById('confirm-modal');
        function showConfirm(title, message, callback) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            confirmCallback = callback;
            confirmModal.classList.remove('hidden');
        }
        document.getElementById('confirm-ok-btn').addEventListener('click', () => {
            if (confirmCallback) confirmCallback(true);
            confirmModal.classList.add('hidden');
        });
        document.getElementById('confirm-cancel-btn').addEventListener('click', () => {
            if (confirmCallback) confirmCallback(false);
            confirmModal.classList.add('hidden');
        });

        function formatTerminTime(startDate, duration) {
            if (!duration) {
                return startDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) + ' Uhr';
            }
            const endDate = new Date(startDate.getTime() + duration * 60000);
            const startTimeStr = startDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            const endTimeStr = endDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            return `${startTimeStr} - ${endTimeStr} Uhr (${duration} Min.)`;
        }

        // --- View Logic ---
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            if (params.has('storno')) {
                handleStorno(params.get('storno'));
            } else if (params.has('admin')) {
                handleAdmin();
            } else {
                displayUserView();
            }
        };

        function displayUserView() {
            mainContent.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Verfügbare Termine</h2>
                    <div id="termin-list" class="space-y-4"></div>
                </div>`;
            
            const q = query(terminCollection, where("status", "==", "frei"));
            onSnapshot(q, (snapshot) => {
                loadingView.classList.add('hidden');
                const terminList = document.getElementById('termin-list');
                if (!terminList) return;

                if (snapshot.empty) {
                    terminList.innerHTML = `<p class="text-gray-500">Aktuell sind leider keine Termine verfügbar.</p>`;
                    return;
                }
                
                const docs = snapshot.docs.sort((a, b) => a.data().datum.toDate() - b.data().datum.toDate());
                terminList.innerHTML = '';
                docs.forEach(doc => {
                    const termin = doc.data();
                    const terminDate = termin.datum.toDate();
                    const formattedDate = terminDate.toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    const timeRange = formatTerminTime(terminDate, termin.dauer);

                    const terminElement = document.createElement('div');
                    terminElement.className = 'flex flex-col md:flex-row justify-between items-center p-4 bg-gray-50 rounded-lg border';
                    terminElement.innerHTML = `
                        <div>
                            <p class="font-semibold text-lg">${formattedDate}</p>
                            <p class="text-gray-600">${timeRange}</p>
                        </div>
                        <button data-id="${doc.id}" data-date="${formattedDate}" data-time="${timeRange}" class="buchen-btn mt-4 md:mt-0 px-5 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition-colors">Buchen</button>`;
                    terminList.appendChild(terminElement);
                });
            }, (error) => {
                console.error("Fehler beim Laden der Termine: ", error);
                mainContent.innerHTML = `<p class="text-red-500">Termine konnten nicht geladen werden.</p>`;
            });
        }

        function handleAdmin() {
            const adminLoginModal = document.getElementById('admin-login-modal');
            adminLoginModal.classList.remove('hidden');
        }
        
        function showAdminDashboard() {
            document.getElementById('admin-login-link').classList.add('hidden');
            mainContent.innerHTML = `
                <div id="admin-header" class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl font-bold">Admin-Dashboard</h2>
                    <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white text-sm rounded-md hover:bg-red-700">Abmelden</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-2xl font-semibold mb-4">Neuen Termin anlegen</h3>
                        <form id="add-termin-form" class="space-y-4">
                            <div>
                                <label for="termin-date" class="block text-sm font-medium text-gray-700">Datum</label>
                                <input type="date" id="termin-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label for="termin-time" class="block text-sm font-medium text-gray-700">Startzeit</label>
                                <input type="time" id="termin-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                             <div>
                                <label for="termin-duration" class="block text-sm font-medium text-gray-700">Dauer (in Minuten)</label>
                                <input type="number" id="termin-duration" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required min="30" step="15" value="90">
                            </div>
                            <button type="submit" class="w-full px-4 py-2 bg-sky-600 text-white font-semibold rounded-md hover:bg-sky-700">Termin erstellen</button>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-2xl font-semibold mb-4">Alle Termine</h3>
                        <div id="admin-termin-list" class="space-y-3 max-h-96 overflow-y-auto"></div>
                    </div>
                </div>`;
            loadingView.classList.add('hidden');
            
            const q = query(terminCollection, orderBy("datum", "asc"));
            onSnapshot(q, (snapshot) => {
                const adminTerminList = document.getElementById('admin-termin-list');
                if (!adminTerminList) return;
                adminTerminList.innerHTML = '';
                snapshot.forEach(doc => {
                    const termin = doc.data();
                    const terminDate = termin.datum.toDate();
                    const formattedDate = terminDate.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const timeRange = formatTerminTime(terminDate, termin.dauer);
                    
                    const isBooked = termin.status === 'gebucht';
                    const element = document.createElement('div');
                    element.className = `p-3 rounded-md border ${isBooked ? 'bg-amber-50 border-amber-200' : 'bg-gray-50'}`;
                    element.innerHTML = `
                        <div class="flex justify-between items-start gap-2">
                            <div class="flex-grow">
                                <p class="font-bold">${formattedDate} - ${timeRange}</p>
                                <p class="text-sm ${isBooked ? 'text-amber-800' : 'text-green-700'} font-semibold">${isBooked ? 'Gebucht' : 'Frei'}</p>
                                ${isBooked ? `<p class="text-xs text-gray-600">${termin.gebuchtVonName} (${termin.gebuchtVonEmail})</p>` : ''}
                                ${isBooked ? `
                                    <details class="text-xs text-gray-500 mt-1 cursor-pointer">
                                        <summary>Mehr Details</summary>
                                        <div class="mt-1 pl-2 border-l-2 border-gray-200">
                                            <p><strong>Kontakt:</strong> ${termin.gebuchtVonKontakt}</p>
                                            <p><strong>Tel:</strong> ${termin.gebuchtVonTelefon}</p>
                                            <p><strong>Adresse:</strong> ${termin.gebuchtVonAdresse}</p>
                                            ${termin.gebuchtVonAnmerkung ? `<p><strong>Anmerkung:</strong> ${termin.gebuchtVonAnmerkung}</p>` : ''}
                                        </div>
                                    </details>
                                ` : ''}
                            </div>
                            <div class="flex flex-col items-end gap-1 flex-shrink-0">
                                <button data-id="${doc.id}" class="admin-edit-btn px-3 py-1 bg-blue-500 text-white text-xs rounded-md hover:bg-blue-600">Bearbeiten</button>
                                <button data-id="${doc.id}" class="admin-delete-btn px-3 py-1 bg-gray-500 text-white text-xs rounded-md hover:bg-gray-600">Löschen</button>
                                ${isBooked ? `<button data-id="${doc.id}" class="admin-storno-btn px-3 py-1 bg-red-600 text-white text-xs rounded-md hover:bg-red-700">Stornieren</button>` : ''}
                            </div>
                        </div>`;
                    adminTerminList.appendChild(element);
                });
            });

            document.getElementById('add-termin-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const date = document.getElementById('termin-date').value;
                const time = document.getElementById('termin-time').value;
                const duration = parseInt(document.getElementById('termin-duration').value, 10);
                const combinedDateTime = new Date(`${date}T${time}`);
                try {
                    await addDoc(terminCollection, { datum: combinedDateTime, status: 'frei', dauer: duration });
                    e.target.reset();
                    showNotification('Termin erfolgreich erstellt!');
                } catch (error) {
                    console.error("Fehler beim Erstellen des Termins: ", error);
                    showNotification('Fehler: Termin konnte nicht erstellt werden.', true);
                }
            });

            document.getElementById('logout-btn').addEventListener('click', async () => {
                await signOut(auth);
                document.getElementById('admin-login-link').classList.remove('hidden');
                window.location.search = "";
            });
        }
        
        async function handleStorno(stornoId) {
            loadingView.classList.remove('hidden');
            mainContent.innerHTML = '';

            const q = query(terminCollection, where("stornoId", "==", stornoId));
            const snapshot = await getDocs(q);

            loadingView.classList.add('hidden');
            if (snapshot.empty) {
                mainContent.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded-lg shadow-md">Dieser Stornierungs-Link ist ungültig oder der Termin wurde bereits storniert.</div>`;
                return;
            }

            const terminDoc = snapshot.docs[0];
            const termin = terminDoc.data();
            const terminDate = termin.datum.toDate();
            const formattedDate = terminDate.toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const timeRange = formatTerminTime(terminDate, termin.dauer);

            mainContent.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md text-center">
                    <h2 class="text-2xl font-semibold mb-2">Termin stornieren</h2>
                    <p class="mb-6">Möchten Sie den folgenden Termin wirklich stornieren?</p>
                    <div class="bg-gray-100 p-4 rounded-lg mb-6 inline-block">
                        <p class="font-bold text-lg">${formattedDate} - ${timeRange}</p>
                        <p>Gebucht von: ${termin.gebuchtVonName}</p>
                    </div>
                    <div>
                        <button id="confirm-storno-btn" data-id="${terminDoc.id}" class="px-6 py-3 bg-red-600 text-white font-bold rounded-md hover:bg-red-700 mr-4">Ja, stornieren</button>
                        <a href="/" class="px-6 py-3 bg-gray-200 text-gray-800 font-bold rounded-md hover:bg-gray-300">Nein, zurück zur Übersicht</a>
                    </div>
                </div>`;
                
            document.getElementById('confirm-storno-btn').addEventListener('click', async (e) => {
                const docId = e.target.dataset.id;
                await cancelAppointment(docId);
                mainContent.innerHTML = `
                    <div class="bg-green-100 text-green-800 p-4 rounded-lg shadow-md text-center">
                        <h2 class="text-2xl font-semibold">Termin erfolgreich storniert!</h2>
                        <p>Der Termin ist nun wieder für andere verfügbar.</p>
                        <a href="/" class="mt-4 inline-block bg-sky-600 text-white px-4 py-2 rounded-md hover:bg-sky-700">Zurück zur Startseite</a>
                    </div>`;
            });
        }

        // --- Database Functions ---
        async function bookAppointment(terminId, institution, person, email, address, phone, notes) {
            const terminRef = doc(db, "termine", terminId);
            try {
                const terminSnap = await getDoc(terminRef);
                if (terminSnap.exists() && terminSnap.data().status === 'frei') {
                    const stornoId = crypto.randomUUID();
                    await updateDoc(terminRef, {
                        status: 'gebucht',
                        gebuchtVonName: institution,
                        gebuchtVonKontakt: person,
                        gebuchtVonEmail: email,
                        gebuchtVonAdresse: address,
                        gebuchtVonTelefon: phone,
                        gebuchtVonAnmerkung: notes,
                        stornoId: stornoId
                    });
                    return { success: true, stornoId: stornoId, terminData: terminSnap.data() };
                } else {
                    return { success: false, message: "Dieser Termin ist leider nicht mehr verfügbar." };
                }
            } catch (error) {
                console.error("Fehler beim Buchen: ", error);
                return { success: false, message: "Ein technischer Fehler ist aufgetreten." };
            }
        }
        
        async function cancelAppointment(terminId) {
            const terminRef = doc(db, "termine", terminId);
             try {
                await updateDoc(terminRef, {
                    status: 'frei',
                    gebuchtVonName: null,
                    gebuchtVonKontakt: null,
                    gebuchtVonEmail: null,
                    gebuchtVonAdresse: null,
                    gebuchtVonTelefon: null,
                    gebuchtVonAnmerkung: null,
                    stornoId: null
                });
                return true;
            } catch (error) {
                console.error("Fehler beim stornieren: ", error);
                return false;
            }
        }

        async function deleteAppointment(terminId) {
            const terminRef = doc(db, "termine", terminId);
            try {
                await deleteDoc(terminRef);
                return true;
            } catch (error) {
                console.error("Fehler beim Löschen des Termins:", error);
                return false;
            }
        }

        async function openEditModal(terminId) {
            const terminRef = doc(db, "termine", terminId);
            const terminSnap = await getDoc(terminRef);
            if (terminSnap.exists()) {
                const termin = terminSnap.data();
                const terminDate = termin.datum.toDate();

                document.getElementById('edit-termin-id').value = terminId;
                const yyyy = terminDate.getFullYear();
                const mm = String(terminDate.getMonth() + 1).padStart(2, '0');
                const dd = String(terminDate.getDate()).padStart(2, '0');
                const hh = String(terminDate.getHours()).padStart(2, '0');
                const min = String(terminDate.getMinutes()).padStart(2, '0');

                document.getElementById('edit-termin-date').value = `${yyyy}-${mm}-${dd}`;
                document.getElementById('edit-termin-time').value = `${hh}:${min}`;
                document.getElementById('edit-termin-duration').value = termin.dauer || 90;

                document.getElementById('edit-termin-modal').classList.remove('hidden');
            } else {
                showNotification("Termin nicht gefunden.", true);
            }
        }

        // --- Event Listeners ---
        const bookingModal = document.getElementById('booking-modal');
        
        document.body.addEventListener('click', (e) => {
            if (e.target.classList.contains('buchen-btn')) {
                const terminId = e.target.dataset.id;
                const terminDate = e.target.dataset.date;
                const terminTime = e.target.dataset.time;
                document.getElementById('termin-id-input').value = terminId;
                document.getElementById('modal-termin-info').innerText = `Termin am ${terminDate} um ${terminTime}.`;
                bookingModal.classList.remove('hidden');
            }
            if (e.target.classList.contains('admin-edit-btn')) {
                const terminId = e.target.dataset.id;
                openEditModal(terminId);
            }
            if (e.target.classList.contains('admin-storno-btn')) {
                const terminId = e.target.dataset.id;
                showConfirm('Buchung stornieren', 'Möchtest du diese Buchung wirklich stornieren?', (confirmed) => {
                    if (confirmed) {
                        cancelAppointment(terminId).then(success => {
                            if (success) showNotification('Buchung storniert. Der Termin ist wieder frei.');
                            else showNotification('Fehler beim Stornieren.', true);
                        });
                    }
                });
            }
            if (e.target.classList.contains('admin-delete-btn')) {
                const terminId = e.target.dataset.id;
                showConfirm('Termin löschen', 'Diesen Termin endgültig löschen? Diese Aktion kann nicht rückgängig gemacht werden!', (confirmed) => {
                    if (confirmed) {
                        deleteAppointment(terminId).then(success => {
                            if (success) showNotification('Termin gelöscht.');
                            else showNotification('Fehler beim Löschen.', true);
                        });
                    }
                });
            }
        });

        document.getElementById('cancel-booking-btn').addEventListener('click', () => {
            bookingModal.classList.add('hidden');
        });

        document.getElementById('booking-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const terminId = document.getElementById('termin-id-input').value;
            const institution = document.getElementById('institution-name').value;
            const person = document.getElementById('contact-person').value;
            const email = document.getElementById('contact-email').value;
            const address = document.getElementById('contact-address').value;
            const phone = document.getElementById('contact-phone').value;
            const notes = document.getElementById('contact-notes').value;

            const result = await bookAppointment(terminId, institution, person, email, address, phone, notes);

            if (result.success) {
                bookingModal.classList.add('hidden');
                e.target.reset();
                const terminDate = result.terminData.datum.toDate();
                const formattedDate = terminDate.toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const timeRange = formatTerminTime(terminDate, result.terminData.dauer);
                const stornoLink = `${window.location.origin}${window.location.pathname}?storno=${result.stornoId}`;
                mainContent.innerHTML = `
                    <div class="bg-green-100 text-green-800 p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold text-center">Vielen Dank für Ihre Buchung!</h2>
                        <p class="mt-2 text-center">Ihr Termin am <strong>${formattedDate} (${timeRange})</strong> wurde erfolgreich reserviert.</p>
                        <div class="mt-6 text-left border-t border-green-200 pt-4">
                            <h3 class="font-bold">Nächste Schritte & Kontakt</h3>
                            <p class="text-sm mt-2">Wir werden uns in Kürze mit Ihnen in Verbindung setzen, um weitere Details zu besprechen. Bei Fragen erreichen Sie uns unter:</p>
                            <div class="mt-2 text-sm p-3 bg-green-50 rounded-md">
                                <p><strong>Dipl.-Ing. Ing. Andreas E. Neuhold, BSc.</strong> (Spieleverein Spieleversum)</p>
                                <p><strong>E-Mail:</strong> andreas.neuhold@gmail.com</p>
                                <p><strong>Telefon:</strong> +43 677 624 639 01</p>
                            </div>
                        </div>
                        <div class="mt-6 bg-yellow-100 text-yellow-800 p-4 rounded-lg border border-yellow-300">
                           <p class="font-bold text-lg text-center">WICHTIG: Link zur Stornierung</p>
                           <p class="mt-2 text-center">Bitte bewahren Sie diesen Link gut auf. Nur mit diesem Link können Sie Ihren Termin wieder stornieren.</p>
                           <input type="text" readonly value="${stornoLink}" class="w-full mt-2 p-2 bg-white rounded-md border border-yellow-400 text-center font-mono">
                        </div>
                         <div class="text-center">
                            <a href="/" class="mt-6 inline-block bg-sky-600 text-white px-4 py-2 rounded-md hover:bg-sky-700">Zurück zur Startseite</a>
                         </div>
                    </div>`;
            } else {
                showNotification(result.message, true);
            }
        });
        
        const impressumModal = document.getElementById('impressum-modal');
        const datenschutzModal = document.getElementById('datenschutz-modal');
        const adminLoginModal = document.getElementById('admin-login-modal');

        document.getElementById('impressum-link').addEventListener('click', (e) => { e.preventDefault(); impressumModal.classList.remove('hidden'); });
        document.getElementById('datenschutz-link').addEventListener('click', (e) => { e.preventDefault(); datenschutzModal.classList.remove('hidden'); });
        document.querySelectorAll('.close-modal-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                impressumModal.classList.add('hidden');
                datenschutzModal.classList.add('hidden');
            });
        });

        document.getElementById('admin-login-link').addEventListener('click', (e) => { e.preventDefault(); handleAdmin(); });
        document.getElementById('cancel-login-btn').addEventListener('click', () => { adminLoginModal.classList.add('hidden'); });
        document.getElementById('cancel-edit-btn').addEventListener('click', () => { document.getElementById('edit-termin-modal').classList.add('hidden'); });

        document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const errorElement = document.getElementById('admin-login-error');
            errorElement.classList.add('hidden');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                adminLoginModal.classList.add('hidden');
                showAdminDashboard();
            } catch (error) {
                console.error("Admin Login failed:", error);
                errorElement.innerText = "Login fehlgeschlagen. Bitte E-Mail und Passwort prüfen.";
                errorElement.classList.remove('hidden');
            }
        });

        document.getElementById('edit-termin-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const terminId = document.getElementById('edit-termin-id').value;
            const date = document.getElementById('edit-termin-date').value;
            const time = document.getElementById('edit-termin-time').value;
            const duration = parseInt(document.getElementById('edit-termin-duration').value, 10);
            
            const combinedDateTime = new Date(`${date}T${time}`);
            const terminRef = doc(db, "termine", terminId);
            
            try {
                await updateDoc(terminRef, { datum: combinedDateTime, dauer: duration });
                showNotification('Termin erfolgreich aktualisiert!');
                document.getElementById('edit-termin-modal').classList.add('hidden');
            } catch (error) {
                console.error("Fehler beim Aktualisieren: ", error);
                showNotification('Fehler: Termin konnte nicht aktualisiert werden.', true);
            }
        });

        onAuthStateChanged(auth, user => {
            const params = new URLSearchParams(window.location.search);
            if (user && params.has('admin')) {
                adminLoginModal.classList.add('hidden');
                showAdminDashboard();
            }
        });

    </script>
</body>
</html>

